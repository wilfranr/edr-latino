<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elden Ring Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        /* Aplicamos las fuentes personalizadas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Un fondo oscuro para la página */
        }
        .font-cinzel {
            font-family: 'Cinzel', serif;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <!-- Pantalla de Lista de Jefes -->
        <main id="screen-zones">
            <header class="text-center mb-6">
                <h1 class="font-cinzel text-4xl font-bold text-amber-400">Zonas de las Tierras Intermedias</h1>
                <div class="mt-4 max-w-lg mx-auto">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-amber-400">Progreso General</span>
                        <span id="overall-progress-text" class="text-sm font-medium text-amber-400">0%</span>
                    </div>
                    <div class="w-full bg-zinc-700 rounded-full h-2.5"><div id="overall-progress-bar" class="bg-amber-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
            </header>

            <div id="loading-indicator" class="text-center text-amber-400 text-xl py-10">Cargando zonas...</div>
            <div id="zone-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de las zonas se insertarán aquí por JavaScript -->
            </div>
        </main>
        
        <!-- Pantalla de Jefes de Zona (oculta por defecto) -->
        <main id="screen-zone-detail" class="hidden">
            <header class="mb-8">
                <button id="back-to-zones-button" class="flex items-center text-amber-400 hover:text-amber-300 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    Volver a las Zonas
                </button>
            </header>
            <div class="text-center mb-4">
                <h1 id="zone-detail-title" class="font-cinzel text-4xl font-bold text-amber-400"></h1>
            </div>

            <!-- Pestañas de navegación -->
            <nav class="flex justify-center border-b border-zinc-700 mb-6">
                <button data-tab="jefes" class="tab-button font-semibold text-amber-400 border-b-2 border-amber-400 py-2 px-4">Jefes <span id="jefes-progress-text" class="text-xs ml-1"></span></button>
                <button data-tab="misiones" class="tab-button font-semibold text-zinc-400 py-2 px-4">Misiones <span id="misiones-progress-text" class="text-xs ml-1"></span></button>
                <button data-tab="armas" class="tab-button font-semibold text-zinc-400 py-2 px-4">Armas <span id="armas-progress-text" class="text-xs ml-1"></span></button>
                <button data-tab="objetos" class="tab-button font-semibold text-zinc-400 py-2 px-4">Objetos <span id="objetos-progress-text" class="text-xs ml-1"></span></button>
            </nav>

            <!-- Contenido de las pestañas -->
            <div id="tab-content-container">
                <div id="tab-jefes" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Contenido de Jefes -->
                </div>
                <div id="tab-misiones" class="tab-content hidden space-y-3">
                    <!-- Contenido de Misiones -->
                </div>
                <div id="tab-armas" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Contenido de Armas -->
                </div>
                <div id="tab-objetos" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Contenido de Objetos -->
                </div>
            </div>
        </main>

        <!-- Pantalla de Detalle de Jefe (oculta por defecto) -->
        <main id="screen-detail" class="hidden">
            <header class="mb-8">
                <button id="back-button" class="flex items-center text-amber-400 hover:text-amber-300 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    Volver
                </button>
            </header>

            <!-- Contenedor para los detalles del jefe -->
            <div id="detail-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                    <img id="detail-image" src="" alt="Imagen del jefe" class="w-full h-auto object-cover rounded-lg shadow-lg border-2 border-zinc-700">
                </div>
                <div class="md:col-span-2">
                    <h2 id="detail-name" class="font-cinzel text-4xl font-bold text-amber-400 mb-4"></h2>
                    <p id="detail-description" class="text-zinc-300 mb-6 text-lg leading-relaxed"></p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-md">
                        <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-amber-500 mb-1">Ubicación</h3>
                            <p id="detail-location" class="text-zinc-200"></p>
                        </div>
                         <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-amber-500 mb-1">Puntos de Vida</h3>
                            <p id="detail-health" class="text-zinc-200"></p>
                        </div>
                        <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-amber-500 mb-1">Runas Obtenidas</h3>
                            <p id="detail-runes" class="text-zinc-200"></p>
                        </div>
                        <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-amber-500 mb-1">Recompensas (Drops)</h3>
                            <ul id="detail-drops" class="list-disc list-inside text-zinc-200"></ul>
                        </div>
                        <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-green-400 mb-1">Debilidades</h3>
                            <ul id="detail-weaknesses" class="list-disc list-inside text-zinc-200"></ul>
                        </div>
                        <div class="bg-zinc-800 p-4 rounded-lg">
                            <h3 class="font-bold text-red-400 mb-1">Fortalezas</h3>
                            <ul id="detail-strengths" class="list-disc list-inside text-zinc-200"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // La API no tiene endpoint de misiones, las mantenemos localmente.
            const mockMissions = [
                { id: "mision01", name: "Misión de Ranni", description: "Ayuda a la bruja Ranni a desafiar a los Dos Dedos y forjar la Edad de las Estrellas.", location: "Liurnia of the Lakes" },
                { id: "mision02", name: "Misión de Fia", description: "Conviértete en el campeón de Fia, la Compañera de la Muerte, para dar a luz a la Runa de la Muerte.", location: "Deeproot Depths" },
                { id: "mision03", name: "Misión de Hyetta", description: "Guía a la doncella Hyetta hacia los Tres Dedos para que se convierta en la portadora de la Llama Frenética.", location: "Subterranean Shunning-Grounds" }
            ];

            // Elementos del DOM
            const screenZones = document.getElementById('screen-zones');
            const screenZoneDetail = document.getElementById('screen-zone-detail');
            const screenDetail = document.getElementById('screen-detail');
            const zoneListContainer = document.getElementById('zone-list');
            const zoneDetailTitle = document.getElementById('zone-detail-title');
            const loadingIndicator = document.getElementById('loading-indicator');
            const backButton = document.getElementById('back-button');
            const backToZonesButton = document.getElementById('back-to-zones-button');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            let gameData = { zones: {}, bosses: [], weapons: [], items: [], misiones: mockMissions };
            let progressState = {};
            const STORAGE_KEY = 'eldenRingProgress';
            let currentZoneId = null;

            // --- MANEJO DE ESTADO Y PROGRESO ---
            function loadProgress() {
                const savedProgress = localStorage.getItem(STORAGE_KEY);
                progressState = savedProgress ? JSON.parse(savedProgress) : {};
            }

            function saveProgress() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(progressState));
            }

            // --- FUNCIONES DE RENDERIZADO Y UI ---

            function renderZones() {
                updateOverallProgressUI();

                try {
                    const zones = Object.values(gameData.zones);

                    // Obtener las dificultades de las regiones y convertirlas a valores numéricos
                    const difficultyValues = {
                        'Fácil': 1,
                        'Medio': 2,
                        'Difícil': 3,
                        'Muy Difícil': 4
                    };
                    
                    const regionDifficulties = {};
                    gameData.regionsDifficulty.forEach(region => {
                        regionDifficulties[region.name] = difficultyValues[region.difficulty] || 999;
                    });

                    // Ordenar las zonas por dificultad de menor a mayor
                    zones.sort((a, b) => {
                        const difficultyA = regionDifficulties[a.name] || 999;
                        const difficultyB = regionDifficulties[b.name] || 999;
                        return difficultyA - difficultyB;
                    });
                    if (!zones || zones.length === 0) throw new Error('No se encontraron datos de zonas en el mock.');
                    
                    loadingIndicator.style.display = 'none';
                    zoneListContainer.innerHTML = ''; // Limpiar la lista

                    zones.forEach(zone => {
                        const zoneProgress = calculateZoneProgress(zone.id);
                        const card = document.createElement('div');
                        card.className = 'bg-zinc-800 p-6 rounded-lg shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300';
                        card.dataset.id = zone.id;

                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-cinzel text-2xl font-bold text-white">${zone.name}</h3>
                                <span class="text-amber-400 font-semibold">${zoneProgress.toFixed(0)}%</span>
                            </div>
                            <p class="text-zinc-400 text-sm mt-2 mb-4 h-10">${zone.description || 'Una de las regiones de las Tierras Intermedias.'}</p>
                            <div class="w-full bg-zinc-700 rounded-full h-2.5"><div class="bg-amber-500 h-2.5 rounded-full" style="width: ${zoneProgress}%"></div></div>
                        `;
                        card.addEventListener('click', () => showZoneDetail(zone.id));
                        zoneListContainer.appendChild(card);
                    });

                } catch (error) {
                    console.error(error);
                    // Mostramos un mensaje de error más descriptivo en la UI
                    loadingIndicator.innerHTML = `
                        <p class="text-red-400">Error al cargar las zonas.</p>
                        <p class="text-zinc-400 text-sm mt-2">${error.message}</p>`;
                }
            }

            function updateOverallProgressUI() {
                const overallProgress = calculateOverallProgress();
                const progressBar = document.getElementById('overall-progress-bar');
                const progressText = document.getElementById('overall-progress-text');
                if (progressBar) progressBar.style.width = `${overallProgress}%`;
                if (progressText) progressText.textContent = `${overallProgress.toFixed(0)}%`;
            }

            function handleCheckboxChange(e) {
                const itemId = e.target.dataset.id;
                const isChecked = e.target.checked;
                progressState[itemId] = isChecked;
                saveProgress();

                // Re-render la vista actual para actualizar barras de progreso
                if (currentZoneId) {
                    showZoneDetail(currentZoneId);
                }
            }

            function renderTabContent(zone, category) {
                const container = document.getElementById(`tab-${category}`);
                let itemIds = zone[category] || [];
                
                // Verificar si la categoría existe en gameData
                if (!gameData[category]) {
                    console.warn(`Categoría '${category}' no encontrada en gameData`);
                    container.innerHTML = `<p class="text-zinc-400 col-span-full text-center">Categoría '${category}' no disponible.</p>`;
                    return;
                }
                
                // Ordenar jefes por dificultad si es la categoría de jefes
                if (category === 'jefes') {
                    itemIds = sortBossesByDifficulty([...itemIds]);
                }
                
                const items = gameData[category].filter(item => itemIds.includes(item.id));

                container.innerHTML = ''; // Limpiar

                if (items.length === 0) {
                    container.innerHTML = `<p class="text-zinc-400 col-span-full text-center">No hay ${category} registrados en esta zona.</p>`;
                    return;
                }

                items.forEach((item, index) => {
                    let cardHtml = '';
                    const isChecked = progressState[item.id] || false;

                    if (category === 'jefes') {
                        const difficulty = calculateBossDifficulty(item);
                        const difficultyText = difficulty <= 2 ? 'Fácil' : difficulty <= 4 ? 'Medio' : difficulty <= 6 ? 'Difícil' : 'Muy Difícil';
                        const difficultyColor = difficulty <= 2 ? 'text-green-400' : difficulty <= 4 ? 'text-yellow-400' : difficulty <= 6 ? 'text-orange-400' : 'text-red-400';
                        
                        cardHtml = `
                            <label class="flex items-center bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700">
                                <input type="checkbox" data-id="${item.id}" class="progress-checkbox h-5 w-5 rounded bg-zinc-900 border-zinc-600 text-amber-500 focus:ring-amber-600" ${isChecked ? 'checked' : ''}>
                                <div class="ml-3 flex-grow">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white ${isChecked ? 'line-through text-zinc-400' : ''}">${index + 1}. ${item.name}</span>
                                        <span class="text-xs ${difficultyColor} font-medium">${difficultyText}</span>
                                    </div>
                                    <div class="flex items-center mt-1 text-xs text-zinc-400">
                                        <span>${item.healthPoints || '???'} HP</span>
                                        ${item.drops && item.drops.find(drop => drop.includes('Runes')) ? 
                                            `<span class="ml-3">${item.drops.find(drop => drop.includes('Runes'))}</span>` : ''}
                                    </div>
                                </div>
                                <button data-boss-id="${item.id}" class="view-detail-btn text-xs text-amber-500 hover:underline ml-2">Ver</button>
                            </label>
                        `;
                    } else {
                        cardHtml = `
                            <label class="flex items-start bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700">
                                <input type="checkbox" data-id="${item.id}" class="progress-checkbox h-5 w-5 rounded bg-zinc-900 border-zinc-600 text-amber-500 focus:ring-amber-600 mt-1" ${isChecked ? 'checked' : ''}>
                                <div class="ml-3">
                                    <span class="font-bold text-white ${isChecked ? 'line-through text-zinc-400' : ''}">${item.name}</span>
                                    <p class="text-zinc-400 text-sm mt-1">${item.description}</p>
                                </div>
                            </label>
                        `;
                    }
                    container.innerHTML += cardHtml;
                });

                container.querySelectorAll('.progress-checkbox').forEach(checkbox => checkbox.addEventListener('change', handleCheckboxChange));
                container.querySelectorAll('.view-detail-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault(); // Evita que el label active el checkbox
                        showBossDetail(e.target.dataset.bossId, zone.id);
                    });
                });
            }

            function showZoneDetail(zoneId) {
                currentZoneId = zoneId;

                screenZones.classList.add('hidden');
                screenDetail.classList.add('hidden');
                screenZoneDetail.classList.remove('hidden');

                const zone = gameData.zones[zoneId];
                if (!zone) {
                    zoneDetailTitle.textContent = 'Zona no encontrada';
                    return;
                }

                zoneDetailTitle.textContent = zone.name;

                // Renderizar contenido para todas las pestañas
                renderTabContent(zone, 'jefes');
                renderTabContent(zone, 'misiones');
                renderTabContent(zone, 'armas');
                renderTabContent(zone, 'objetos');
                
                // Agregar indicador de ordenamiento por dificultad en la pestaña de jefes
                const jefesTab = document.getElementById('tab-jefes');
                if (jefesTab && zone.jefes && zone.jefes.length > 0) {
                    const orderIndicator = document.createElement('div');
                    orderIndicator.className = 'text-xs text-zinc-500 text-center mb-3 p-2 bg-zinc-900 rounded';
                    orderIndicator.innerHTML = '🗡️ Jefes ordenados por dificultad (más fácil → más difícil)';
                    jefesTab.insertBefore(orderIndicator, jefesTab.firstChild);
                }

                // Actualizar porcentajes de las pestañas
                ['jefes', 'misiones', 'armas', 'objetos'].forEach(category => {
                    const progress = calculateProgress(zone[category] || []);
                    const textElement = document.getElementById(`${category}-progress-text`);
                    if (textElement) {
                        textElement.textContent = `(${progress.toFixed(0)}%)`;
                    }
                });

                // Activar la primera pestaña por defecto
                tabButtons.forEach(btn => {
                    if (btn.dataset.tab === 'jefes') {
                        btn.classList.add('text-amber-400', 'border-amber-400');
                        btn.classList.remove('text-zinc-400');
                    } else {
                        btn.classList.remove('text-amber-400', 'border-amber-400');
                        btn.classList.add('text-zinc-400');
                    }
                });
                tabContents.forEach(content => {
                    if (content.id === 'tab-jefes') {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });

                window.scrollTo(0, 0);
            }

            // --- FUNCIONES DE CÁLCULO ---
            
            // Función para calcular la dificultad de un jefe
            function calculateBossDifficulty(boss) {
                let difficulty = 0;
                
                // Basado en puntos de vida
                if (boss.healthPoints) {
                    const health = parseInt(boss.healthPoints.replace(/[^\d]/g, '')) || 0;
                    if (health > 0) {
                        if (health < 5000) difficulty += 1;
                        else if (health < 15000) difficulty += 2;
                        else if (health < 50000) difficulty += 3;
                        else difficulty += 4;
                    }
                }
                
                // Basado en runas (recompensa)
                if (boss.drops) {
                    const runes = boss.drops.find(drop => drop.includes('Runes'));
                    if (runes) {
                        const runeAmount = parseInt(runes.replace(/[^\d]/g, '')) || 0;
                        if (runeAmount > 100000) difficulty += 3;
                        else if (runeAmount > 50000) difficulty += 2;
                        else if (runeAmount > 10000) difficulty += 1;
                    }
                }
                
                // Jefes especiales conocidos por su dificultad
                const hardBosses = ['malenia', 'elden beast', 'radagon', 'maliketh', 'radahn'];
                if (hardBosses.some(hardBoss => boss.name.toLowerCase().includes(hardBoss))) {
                    difficulty += 2;
                }
                
                return difficulty;
            }
            
            // Función para ordenar jefes por dificultad
            function sortBossesByDifficulty(bossIds) {
                return bossIds.sort((a, b) => {
                    const bossA = gameData.bosses.find(boss => boss.id === a);
                    const bossB = gameData.bosses.find(boss => boss.id === b);
                    
                    if (!bossA || !bossB) return 0;
                    
                    const difficultyA = calculateBossDifficulty(bossA);
                    const difficultyB = calculateBossDifficulty(bossB);
                    
                    return difficultyA - difficultyB; // Orden ascendente (más fácil primero)
                });
            }
            
            function calculateProgress(itemIds) {
                if (!itemIds || itemIds.length === 0) return 100;
                const completedItems = itemIds.filter(id => progressState[id]).length;
                return (completedItems / itemIds.length) * 100;
            }

            function calculateZoneProgress(zoneId) {
                const zone = gameData.zones[zoneId];
                if (!zone) return 0;
                const bossProgress = calculateProgress(zone.jefes || []);
                const missionProgress = calculateProgress(zone.misiones || []);
                return (bossProgress + missionProgress) / 2;
            }

            function calculateOverallProgress() {
                const zoneIds = Object.keys(gameData.zones);
                if (zoneIds.length === 0) return 0;
                const totalProgress = zoneIds.reduce((sum, zoneId) => sum + calculateZoneProgress(zoneId), 0);
                return totalProgress / zoneIds.length;
            }

            function showBossDetail(bossId, fromZoneId) {
                screenZones.classList.add('hidden');
                screenZoneDetail.classList.add('hidden');
                screenDetail.classList.remove('hidden');
                document.getElementById('detail-content').classList.add('hidden');

                try {
                    const boss = gameData.bosses.find(b => b.id === bossId);
                    if (!boss) throw new Error('No se pudo encontrar el detalle del jefe.');

                    // Guardar el contexto de la zona para el botón de regreso
                    backButton.dataset.fromZone = fromZoneId;

                    // Rellenar los detalles
                    document.getElementById('detail-image').src = boss.image || 'https://via.placeholder.com/400x225.png?text=No+Image';
                    document.getElementById('detail-name').textContent = boss.name;
                    document.getElementById('detail-description').textContent = boss.description || 'No hay descripción disponible.';
                    document.getElementById('detail-location').textContent = boss.location || 'Desconocida';
                    document.getElementById('detail-health').textContent = boss.healthPoints || 'No disponible';
                    document.getElementById('detail-runes').textContent = boss.runes ? new Intl.NumberFormat().format(boss.runes) : 'No disponible';
                    
                    const dropsList = document.getElementById('detail-drops');
                    dropsList.innerHTML = '';

                    if (boss.drops && boss.drops.length > 0) {
                        boss.drops.forEach(drop => {
                            const li = document.createElement('li');
                            li.textContent = drop;
                            dropsList.appendChild(li);
                        });
                    } else {
                        dropsList.innerHTML = '<li>No se conocen recompensas.</li>';
                    }

                    const weaknessesList = document.getElementById('detail-weaknesses');
                    weaknessesList.innerHTML = '';
                    if (boss.weaknesses && boss.weaknesses.length > 0) {
                        boss.weaknesses.forEach(weakness => {
                            const li = document.createElement('li');
                            li.textContent = weakness;
                            weaknessesList.appendChild(li);
                        });
                    } else {
                        weaknessesList.innerHTML = '<li>Ninguna conocida.</li>';
                    }

                    const strengthsList = document.getElementById('detail-strengths');
                    strengthsList.innerHTML = '';
                    if (boss.strengths && boss.strengths.length > 0) {
                        boss.strengths.forEach(strength => {
                            const li = document.createElement('li');
                            li.textContent = strength;
                            strengthsList.appendChild(li);
                        });
                    } else {
                        strengthsList.innerHTML = '<li>Ninguna conocida.</li>';
                    }

                    document.getElementById('detail-content').classList.remove('hidden'); // Mostrar contenido
                    window.scrollTo(0, 0); // Ir al inicio de la página

                } catch (error) {
                    // Si falla la carga del detalle, mostramos un error claro
                    document.getElementById('detail-name').textContent = 'Error al cargar';
                    document.getElementById('detail-description').textContent = `No se pudo obtener el detalle de este jefe. ${error.message}`;
                    console.error(error);
                }
            }

            function processApiData() {
                // Primero, inicializamos las zonas a partir de las regiones únicas en locations.json
                gameData.zones = {}; // Limpiar zonas existentes
                const uniqueRegions = new Set();

                gameData.locations.forEach(location => {
                    if (location.region && !uniqueRegions.has(location.region)) {
                        const zoneName = location.region.trim();
                        const zoneId = zoneName.toLowerCase().replace(/\s+/g, '-');
                        gameData.zones[zoneId] = {
                            id: zoneId,
                            name: zoneName,
                            description: `Explora la región de ${zoneName}.`,
                            jefes: [],
                            misiones: [],
                            armas: [],
                            objetos: []
                        };
                        uniqueRegions.add(location.region);
                    }
                });

                // Mapeo automático de jefes a regiones basado en los datos reales
                gameData.bosses.forEach(boss => {
                    if (!boss.region) return;
                    
                    // Convertir el nombre de la región a un ID de zona
                    let regionId = null;
                    const regionName = boss.region.toLowerCase();
                    
                    if (regionName.includes('limgrave')) {
                        regionId = 'limgrave';
                    } else if (regionName.includes('weeping peninsula')) {
                        regionId = 'weeping-peninsula';
                    } else if (regionName.includes('liurnia') || regionName.includes('liunia')) {
                        regionId = 'liurnia-of-the-lakes';
                    } else if (regionName.includes('caelid') || regionName.includes('dragonbarrow')) {
                        regionId = 'caelid';
                    } else if (regionName.includes('altus plateau') || regionName.includes('leyndell')) {
                        regionId = 'altus-pleateau';
                    } else if (regionName.includes('mountaintop') || regionName.includes('consecrated snowfield') || regionName.includes('haligtree')) {
                        regionId = 'mountaintops-of-the-giants';
                    } else if (regionName.includes('mount gelmir') || regionName.includes('volcano manor')) {
                        regionId = 'mount-gelmir';
                    } else if (regionName.includes('deeproot') || regionName.includes('mohgwyn')) {
                        regionId = 'deeproot-depths';
                    } else if (regionName.includes('crumbling farum azula')) {
                        regionId = 'crumbling-farum-azula';
                    }

                    if (regionId && gameData.zones[regionId]) {
                        if (!gameData.zones[regionId].jefes.includes(boss.id)) {
                            gameData.zones[regionId].jefes.push(boss.id);
                        }
                    }
                });

                // Asignar objetos a sus regiones
                gameData.items.forEach(item => {
                    if (!item.location) return;
                    
                    // Mapeo manual de ubicaciones a regiones
                    let regionId = null;
                    if (item.location.includes('Limgrave') || item.location.includes('Stormhill') || item.location.includes('Stormveil')) {
                        regionId = 'limgrave';
                    } else if (item.location.includes('Weeping Peninsula') || item.location.includes('Castle Morne')) {
                        regionId = 'weeping-peninsula';
                    } else if (item.location.includes('Liurnia') || item.location.includes('Raya Lucaria')) {
                        regionId = 'liurnia-of-the-lakes';
                    } else if (item.location.includes('Caelid')) {
                        regionId = 'caelid';
                    } else if (item.location.includes('Altus Plateau') || item.location.includes('Leyndell')) {
                        regionId = 'altus-pleateau';
                    } else if (item.location.includes('Mountaintops') || item.location.includes('Haligtree')) {
                        regionId = 'mountaintops-of-the-giants';
                    }

                    if (regionId && gameData.zones[regionId]) {
                        if (!gameData.zones[regionId].objetos.includes(item.id)) {
                            gameData.zones[regionId].objetos.push(item.id);
                        }
                    }
                });

                // Asignar armas a regiones (ejemplo básico)
                gameData.weapons.forEach(weapon => {
                    if (!weapon.location) return;
                    
                    let regionId = null;
                    if (weapon.location.includes('Limgrave') || weapon.location.includes('Stormveil')) {
                        regionId = 'limgrave';
                    } else if (weapon.location.includes('Liurnia') || weapon.location.includes('Raya Lucaria')) {
                        regionId = 'liurnia-of-the-lakes';
                    } else if (weapon.location.includes('Caelid')) {
                        regionId = 'caelid';
                    }

                    if (regionId && gameData.zones[regionId]) {
                        if (!gameData.zones[regionId].armas.includes(weapon.id)) {
                            gameData.zones[regionId].armas.push(weapon.id);
                        }
                    }
                });

                // Asignar misiones a regiones basándose en la propiedad region del archivo
                if (gameData.misiones && gameData.misiones.length > 0) {
                    gameData.misiones.forEach(mision => {
                        if (mision.region && gameData.zones[mision.region]) {
                            if (!gameData.zones[mision.region].misiones.includes(mision.id)) {
                                gameData.zones[mision.region].misiones.push(mision.id);
                            }
                        }
                    });
                }

                console.log('Zonas procesadas:', Object.keys(gameData.zones));
                console.log('Jefes por zona:', Object.values(gameData.zones).map(zone => ({
                    name: zone.name,
                    jefes: zone.jefes.length,
                    objetos: zone.objetos.length,
                    armas: zone.armas.length,
                    misiones: zone.misiones.length
                })));
            }

            async function initializeApp() {
                try {
                    loadingIndicator.textContent = 'Cargando archivos de datos...';

                    const [bossesRes, weaponsRes, itemsRes, locationsRes, regionsDifficultyRes, missionsRes] = await Promise.all([
                        fetch('./data/bosses.json'),
                        fetch('./data/weapons_es.json'),
                        fetch('./data/items_es.json'),
                        fetch('./data/locations_es.json'),
                        fetch('./data/regions_difficulty_es.json'),
                        fetch('./data/missions_es.json')
                    ]);

                    // Los archivos JSON son arrays directamente, no necesitan .data
                    gameData.bosses = await bossesRes.json();
                    gameData.weapons = await weaponsRes.json();
                    gameData.items = await itemsRes.json();
                    gameData.locations = await locationsRes.json();
                    gameData.regionsDifficulty = await regionsDifficultyRes.json();
                    gameData.misiones = await missionsRes.json();
                    
                    // Inicializar categorías que pueden no existir
                    if (!gameData.armas) gameData.armas = [];
                    if (!gameData.objetos) gameData.objetos = [];
                    
                    // Crear alias para compatibilidad con nombres en español
                    gameData.jefes = gameData.bosses;
                    gameData.armas = gameData.weapons;
                    gameData.objetos = gameData.items;

                    processApiData();
                    console.log("Unique Regions:", Object.values(gameData.zones).map(zone => zone.name));
                    loadProgress();
                    renderZones();
                } catch (error) {
                    loadingIndicator.innerHTML = `<p class="text-red-400">Error al cargar los archivos de datos. Asegúrate de que la carpeta /data y los archivos JSON existen. <br><br> ${error.message}</p>`;
                }
            }

            // --- NAVEGACIÓN ---
            backButton.addEventListener('click', () => {
                const fromZone = backButton.dataset.fromZone;
                if (fromZone) {
                    showZoneDetail(fromZone);
                }
            });

            backToZonesButton.addEventListener('click', () => {
                screenZoneDetail.classList.add('hidden');
                currentZoneId = null;
                renderZones(); // Re-render para mostrar progreso actualizado
                screenZones.classList.remove('hidden');
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-amber-400', 'border-amber-400');
                        btn.classList.add('text-zinc-400');
                    });
                    button.classList.add('text-amber-400', 'border-amber-400');
                    button.classList.remove('text-zinc-400');

                    tabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== `tab-${tabId}`);
                    });
                });
            });

            // Iniciar la carga de datos
            initializeApp();
        });
    </script>
</body>
</html>
